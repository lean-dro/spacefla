<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <link
      rel="shortcut icon"
      href="../assets/icon/LOGO.svg"
      type="image/x-icon"
    />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
     <script
      src="https://kit.fontawesome.com/ac1eabd3cd.js"
      crossorigin="anonymous"
    ></script> 

    <link rel="stylesheet" href="../assets/css/reset.css" />
    <link rel="stylesheet" href="../assets/css/style.css" />
    <link rel="stylesheet" href="../assets/css/home-space.css" />
    <link rel="stylesheet" href="../assets/css/menu.css" />
    <link rel="stylesheet" href="../assets/css/modal.css" />

    <script src="../assets/js/funcoes.js"></script>
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>spacefla | home</title>
  </head>
  <body onload="validarSessao(), obterCornetas(), obterCornetasCurtidas(), buscarTopJogadores(), buscarTopCorneta()">
    <div id="fundo_modal" class="fundo-modal">
      <div class="modal">
        <div class="modal-escopo">
          <i
            onclick="toggleModal(this)"
            class="fa-solid fa-xmark botao-close-modal"
          ></i>
          <h1 class="titulo-modal">Faça sua corneta</h1>
          <div class="selects">
            <select class="select-secundario" name="" id="select_atuacao">
              <option value="">Atuação</option>
              <option style="color: #5dd299" value="Jogando bem">Jogando bem</option>
              <option style="color: #f3b72f" value="Jogando mal">Jogando mal</option>
            </select>
            <select class="select-secundario" name="" id="select_competicao">
              <option value="0">Competição</option>
              <option value="Brasileiro">Brasileiro</option>
              <option value="Copa do Brasil">Copa do Brasil</option>
              <option value="Libertadores">Libertadores</option>
            </select>
          </div>
          <div class="analise">
            <textarea
              wrap="hard"
              cols="10"
              rows="10"
              name=""
              id="textarea_analise"
              placeholder="Faça sua análise..."
            ></textarea>
          </div>
          <span id="span_aviso"></span>
        </div>
        <div class="modal-foto-botao">
          <div id="foto_modal" class="fotoJogador-modal "></div>
          <select onchange="atualizarJogador()" id="select_jogador"  class="select-jogador" name="" id="">
            <option value="">Escolha um Jogador</option>
           
          </select>
          <div class="botao-modal" onclick="validarCadastro()">
            <img class="corneta-icon" src="../assets/icon/corneta.svg" alt="" />
          </div>
        </div>
      </div>
    </div>

    <div id="conteudo">
      <div class="menu">
        <div class="escopo-menu">
          <div class="logo-menu">
            <img src="../assets/icon/LOGO.svg" alt="" />
          </div>
          <div class="tabs">
            <div class="item-tab">
              <svg
                class="tab-icon"
                xmlns="http://www.w3.org/2000/svg"
                viewBox="0 0 576 512"
              >
                <!--! Font Awesome Pro 6.4.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license (Commercial License) Copyright 2023 Fonticons, Inc. -->
                <path
                  d="M575.8 255.5c0 18-15 32.1-32 32.1h-32l.7 160.2c0 2.7-.2 5.4-.5 8.1V472c0 22.1-17.9 40-40 40H456c-1.1 0-2.2 0-3.3-.1c-1.4 .1-2.8 .1-4.2 .1H416 392c-22.1 0-40-17.9-40-40V448 384c0-17.7-14.3-32-32-32H256c-17.7 0-32 14.3-32 32v64 24c0 22.1-17.9 40-40 40H160 128.1c-1.5 0-3-.1-4.5-.2c-1.2 .1-2.4 .2-3.6 .2H104c-22.1 0-40-17.9-40-40V360c0-.9 0-1.9 .1-2.8V287.6H32c-18 0-32-14-32-32.1c0-9 3-17 10-24L266.4 8c7-7 15-8 22-8s15 2 21 7L564.8 231.5c8 7 12 15 11 24z"
                />
              </svg>

              <span>feed</span>
            </div>
            <div class="item-tab">
              <svg
                class="tab-icon"
                xmlns="http://www.w3.org/2000/svg"
                viewBox="0 0 512 512"
              >
                <!--! Font Awesome Pro 6.4.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license (Commercial License) Copyright 2023 Fonticons, Inc. -->
                <path
                  d="M32 32c17.7 0 32 14.3 32 32V400c0 8.8 7.2 16 16 16H480c17.7 0 32 14.3 32 32s-14.3 32-32 32H80c-44.2 0-80-35.8-80-80V64C0 46.3 14.3 32 32 32zM160 224c17.7 0 32 14.3 32 32v64c0 17.7-14.3 32-32 32s-32-14.3-32-32V256c0-17.7 14.3-32 32-32zm128-64V320c0 17.7-14.3 32-32 32s-32-14.3-32-32V160c0-17.7 14.3-32 32-32s32 14.3 32 32zm64 32c17.7 0 32 14.3 32 32v96c0 17.7-14.3 32-32 32s-32-14.3-32-32V224c0-17.7 14.3-32 32-32zM480 96V320c0 17.7-14.3 32-32 32s-32-14.3-32-32V96c0-17.7 14.3-32 32-32s32 14.3 32 32z"
                />
              </svg>

              <span> dados </span>
            </div>
            <div onclick="toggleModal()" class="item-tab botao-corneta">
              <img
                src="../assets/icon/corneta.svg"
                class="corneta-icon"
                alt=""
              />
              <span> cornetar </span>
            </div>
          </div>
          <div class="tab-sair">
            <div onclick="sair()" class="item-tab">
              <svg class="tab-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><!--! Font Awesome Pro 6.4.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license (Commercial License) Copyright 2023 Fonticons, Inc. --><path d="M377.9 105.9L500.7 228.7c7.2 7.2 11.3 17.1 11.3 27.3s-4.1 20.1-11.3 27.3L377.9 406.1c-6.4 6.4-15 9.9-24 9.9c-18.7 0-33.9-15.2-33.9-33.9l0-62.1-128 0c-17.7 0-32-14.3-32-32l0-64c0-17.7 14.3-32 32-32l128 0 0-62.1c0-18.7 15.2-33.9 33.9-33.9c9 0 17.6 3.6 24 9.9zM160 96L96 96c-17.7 0-32 14.3-32 32l0 256c0 17.7 14.3 32 32 32l64 0c17.7 0 32 14.3 32 32s-14.3 32-32 32l-64 0c-53 0-96-43-96-96L0 128C0 75 43 32 96 32l64 0c17.7 0 32 14.3 32 32s-14.3 32-32 32z"/></svg>  
              <span>sair</span>
            </div>
          </div>
        </div>
      </div>

      <div id="feed" class="feed"></div>

      <div class="infos">
        <div class="perfil">
          <img class="escudo-perfil" src="../assets/icon/ESCUDO.svg" alt="">
          <p id="usuario_perfil"></p>
        </div>
        
        <div class="lista-jogadores">
          <div class="titulo-lista">Top 3 Jogadores mais comentados</div>
          <div id="lista">
            
          </div>
        </div>

        <div class="top-corneta">
          <div class="titulo-lista">Corneta mais curtida</div>

          <div id="top_corneta_corpo">

          </div>

        </div>

      </div>
    </div>
  </body>
</html>
<script>
  usuario_perfil.innerHTML = sessionStorage.NOME_USUARIO
  var ultimoJogador="";
  var cornetas = [];
  var cornetasCurtidas = []
  var cornetaTop = {}
  var contadorCurtidos;

async function buscarTopCorneta() {
  await fetch("/cornetas/listar-top",{
    method: "get",
    headers:{
      "Content-type": "application/json"
    }
  }).then(function(resposta) {
    if(resposta.ok){
      resposta.json().then((json)=>{
        cornetaTop = json[0]
        gerarTopCorneta()
      })
    }else{
      top_corneta_corpo.innerHTML = "Sem cornetas mais curtidas por enquanto..."
    }
  })
}
function gerarTopCorneta() {
  var classeTipo;
  var classeCurtida = "curtir";
              if (cornetaTop.tipoCorneta == "Jogando bem") {
                classeTipo = "Positiva";
              } else {
                classeTipo = "Negativa";
              }
              for(contadorCurtidos = 0; contadorCurtidos < cornetasCurtidas.length; contadorCurtidos++){
                if(cornetasCurtidas[contadorCurtidos].fkCorneta == cornetaTop.idCorneta){
                  classeCurtida = "curtido"
                  contadorCurtidos = cornetasCurtidas.length-1
                }else{
                  classeCurtida = "curtir"
                }
              }

  top_corneta_corpo.innerHTML = `
  <div class="usuario-analise-top">
              <div class="usuario-top">@${cornetaTop.nomeUsuario}</div>
              <div class="analise-top">
                ${cornetaTop.comentarioCorneta}  
              </div>
            </div>
            <div class="info-foto-corneta-top">
              <div class="info-corneta-top">
                <img class='icon-competicao' src="../assets/img/competicao/${cornetaTop.competicao}.png" alt="">
                <p class="tipo-corneta ${classeTipo}">${cornetaTop.tipoCorneta}</p>

                <div class="curtir-top">
                  <div class="botao-efeito">
                    <div onclick="curtir(this, ${cornetaTop.idCorneta})" id="botao${cornetaTop.idCorneta}" class="botao ${classeCurtida}"></div>
                  </div>
                  <span id='span_curtidas'>${cornetaTop.curtidas}</span>
                </div>
              </div>
              <div class="foto-corneta-top">
                <div class="fotoJogador j${cornetaTop.fkJogador}"></div>
              </div>
            </div>
  
  `
}
function buscarTopJogadores() {
  lista.innerHTML=""
    fetch("/jogadores/listar-top",{
      method: "get",
      headers: {
        "Content-type": "application/json",
      },
    }).then(function(resposta) {
      resposta.json().then(function(json) {
        for (var contadorTopJogadores = 0;contadorTopJogadores < json.length;contadorTopJogadores++) {
          lista.innerHTML += `
            <div class="item-lista">${json[contadorTopJogadores]}</div>
          `
        }
      })
    })
}

 async function curtir(x, corneta) {
    
      
    
    if(x.classList.contains("curtido")){
      x.classList.remove("curtido")
      x.classList.add("curtir")
    }else{
      x.classList.remove("curtir")
      x.classList.add("curtido")
    }
    x.classList.toggle("curtido")
    
    console.log(x)
    fetch("/curtidas/verificar",{
      method: "post",
      headers: {
        "Content-type": "application/json",
      },
      body: JSON.stringify({
        cornetaServer: corneta,
        usuarioServer: sessionStorage.ID_USUARIO
      })
    }).then(function(resposta) {
        if(resposta.ok){
          resposta.json().then(function(curtidas) {
           
            console.log(curtidas)
            obterCornetasCurtidas()
            obterCornetas()
            gerarCornetas()
            buscarTopCorneta()
            gerarTopCorneta()
          })
        }else{
          console.log("erro")
        }
    })
    
  }

  function atualizarJogador() {
    var foto = document.getElementById("foto_modal").classList;
    var idJogador = select_jogador.value;
    var classe
    if(ultimoJogador == ""){
       classe = "j"+idJogador;
       foto.add(classe)
       ultimoJogador = classe;
    }else{
      foto.remove(ultimoJogador);
      classe = "j"+idJogador;
      foto.add(classe)
      ultimoJogador = classe;
    }
   
    
  }
  function toggleModal() {
    fundo_modal.classList.toggle("show");
    buscarJogadores();
  }
  async function obterCornetasCurtidas() {
    await fetch("/cornetas/listarCurtidos", {
      method: "post",
      headers: {
        "Content-type": "application/json",
      },
      body: JSON.stringify({
        usuarioServer: sessionStorage.ID_USUARIO 
      })
    }).then(function(resposta) {
      if (resposta.ok) {
        resposta.json().then((json) => {
          cornetasCurtidas = json
        }).catch(function(erro) {
          console.log(erro)
        });
      }
    })
  }
  async function obterCornetas() {
    await fetch("/cornetas/listar", {
      method: "get",
      headers: {
        "Content-type": "application/json",
      },
    }).then(function (resposta) {
      if (resposta.ok) {
        resposta.json().then((json) => {
          if (json.length == 0) {
            feed.innerHTML = "Sem cornetas por enquanto...";
          } else {
            cornetas = json
            gerarCornetas()
          }
        }).catch(function(erro) {
          console.log(erro)
        });
      } else {
        feed.innerHTML = "Sem cornetas por enquanto...";
      }
    }).catch(function(erro){
      console.log(erro)
    });
  }

  function buscarJogadores() {
    fetch("/jogadores/listar", {
      method: "get",
      headers: {
        "Content-type": "application/json",
      },
    }).then(function (resposta) {
      if (resposta.ok) {
        resposta.json().then((json) =>{
          for (var contadorJogadores = 0; contadorJogadores < json.length; contadorJogadores++) {
            select_jogador.innerHTML += `<option value='${json[contadorJogadores].idJogador}'>${json[contadorJogadores].nomeJogador}</option>`
          }
        })
      }
    });
  }
  function validarCadastro() {
    var atuacao = select_atuacao.value;
    var competicao = select_competicao.value;
    var jogador =  select_jogador.value;
    var analise = textarea_analise.value;

    var entradasInvalidas = 
    (atuacao == 0) ||
    (competicao == 0) ||
    (jogador == 0) ||
    (analise.length == 0)
    
    if(entradasInvalidas){
      if(atuacao == 0){
        span_aviso.innerHTML = "Selecione a atuação!"
      }else if(competicao == 0){
        span_aviso.innerHTML = "Selecione a competição!"
      }else if(jogador == 0){
        span_aviso.innerHTML = "Selecione um jogador!"
      }else{
        span_aviso.innerHTML = "Faça uma análise!"
      }
    }else{
      cadastrarCorneta(atuacao, competicao, jogador, analise)
    }

  }
  function cadastrarCorneta(tipo, competicao, jogador, analise) {
    fetch('/cornetas/cadastrar',{
      method: "post",
      headers: {
        "Content-type": "application/json",
      },
      body: JSON.stringify({
        tipoServer: tipo,
        competicaoServer: competicao,
        jogadorServer: jogador,
        comentarioServer: analise,
        usuarioServer: sessionStorage.ID_USUARIO
      }),
    }).then(function(resposta) {
      if(resposta.ok){
        setTimeout(() => {
          feed.innerHTML = ""
          obterCornetas()
          gerarCornetas()
          buscarTopJogadores()
          toggleModal()
        }, 500);
      }else{
        alert("ero")
      }
    })
  }
  


  function gerarCornetas() {
    
    feed.innerHTML ="";
    for (var contador = 0; contador < cornetas.length; contador++) {
    
              var corneta = cornetas[contador].idCorneta;
              var comentario = cornetas[contador].comentarioCorneta;
              var idJogador = cornetas[contador].fkJogador;
              var usuario = cornetas[contador].nomeUsuario;
              var competicao = cornetas[contador].competicao;
              var tipo = cornetas[contador].tipoCorneta;
              var classeTipo;
              var curtidas = cornetas[contador].curtidas 
              var classeCurtida = "curtir";
              if (tipo == "Jogando bem") {
                classeTipo = "Positiva";
              } else {
                classeTipo = "Negativa";
              }
              for(contadorCurtidos = 0; contadorCurtidos < cornetasCurtidas.length; contadorCurtidos++){
                if(cornetasCurtidas[contadorCurtidos].fkCorneta == corneta){
                  classeCurtida = "curtido"
                  contadorCurtidos = cornetasCurtidas.length-1
                }else{
                  classeCurtida = "curtir"
                }
              }
              feed.innerHTML += `
            
                    <div class="corneta">
                          <div class="escopoCorneta">
                            <div class="conteudoCorneta">
                              <div class='infosCorneta'>
                                <p class="usuario">@${usuario} </p>
                                <img class='icon-competicao' src="../assets/img/competicao/${competicao}.png" alt="">
                                <p class='tipo-corneta ${classeTipo}'>${tipo}</p>

                                </div>
                              <p class="comentario">${comentario}</p>
                            </div>
                            
                            <div class="cornetaCurtir">
                              <div class="botao-efeito">
                              <div onclick="curtir(this, ${corneta})" id="botao${corneta}" class="botao ${classeCurtida}"></div>
                              </div>
                              <span id='span_curtidas${corneta}'>${curtidas}</span>
                            </div>

                          </div>
                          <div class="fotoJogador j${idJogador}"></div>
                        </div>
                    `;             

            }
  
  }
 
  
 
</script>
